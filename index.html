<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿv4.0 (è½‰ç›¤+å£è¢‹åå–®)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F97316;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-anim {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-anim:active {
            transform: scale(0.98);
        }
        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #F97316;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 2px;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Wheel Styling */
        #wheel-canvas {
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); 
            /* We will handle rotation via JS mostly, but CSS transition is a backup */
        }
        .arrow-down {
            width: 0; 
            height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #DC2626; /* Red arrow */
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-utensils text-orange-500 mr-2"></i>ä»Šå¤©åƒä»€éº¼</h1>
            <p class="text-xs text-gray-500">Hi æ™¨æ™¨ï¼Œ<span id="date-display"></span></p>
        </div>
        <div class="flex gap-3">
            <button onclick="openHistory()" class="bg-gray-100 p-2 rounded-full text-gray-600 hover:bg-gray-200 transition relative">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            <div id="status-badge" class="hidden px-2 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600 flex items-center">
                å®šä½ä¸­...
            </div>
        </div>
    </header>

    <!-- Controls -->
    <div class="bg-white border-b border-gray-200 pb-2">
        <div class="px-4 py-2" id="range-container">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span>æœå°‹ç¯„åœ</span>
                <span id="range-value" class="font-bold text-orange-600">500 å…¬å°º</span>
            </div>
            <input type="range" id="distance-range" min="100" max="1000" step="100" value="500" class="w-full">
        </div>

        <div class="px-4 flex gap-2 overflow-x-auto whitespace-nowrap scrollbar-hide pb-2">
            <button onclick="setMode('all')" id="btn-all" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-orange-500 text-white shadow-md transition">
                é™„è¿‘ç¾é£Ÿ
            </button>
            <button onclick="setMode('date')" id="btn-date" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                ğŸ’• æ£ æ£ ç´„æœƒ
            </button>
            <button onclick="askCustomSearch()" id="btn-custom" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition border border-gray-200">
                ğŸ” è‡ªè¨‚æœå°‹
            </button>
            <button onclick="setMode('pocket')" id="btn-pocket" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition border border-gray-200">
                â­ å£è¢‹åå–®
            </button>
        </div>
        
        <!-- Keyword Display -->
        <div id="keyword-badge" class="hidden px-4 py-1">
            <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-md">
                æœå°‹ä¸­ï¼š<span id="current-keyword-text"></span>
                <button onclick="setMode('all')" class="ml-2 text-orange-400 hover:text-orange-700"><i class="fa-solid fa-xmark"></i></button>
            </span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 relative" id="main-container">
        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6 pt-10">
            <div class="relative">
                <div class="w-32 h-32 bg-orange-100 rounded-full flex items-center justify-center animate-bounce">
                    <i class="fa-solid fa-location-dot text-5xl text-orange-500"></i>
                </div>
                <div class="absolute top-0 left-0 w-32 h-32 bg-orange-400 rounded-full opacity-20 animate-ping"></div>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">æœå°‹é™„è¿‘çš„ç¾å‘³</h2>
                <p class="text-gray-500 mt-2 text-sm px-8">é»æ“Šé–‹å§‹ï¼Œæ‰¾å‡ºå‘¨åœ <span id="start-range-text">500</span> å…¬å°ºå…§çš„å¥½æ–™</p>
            </div>
            <button onclick="getLocation()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-10 rounded-xl shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center text-lg">
                <i class="fa-solid fa-magnifying-glass-location mr-2"></i> é–‹å§‹æœå°‹
            </button>
        </div>

        <!-- Loading -->
        <div id="loading-screen" class="hidden flex flex-col items-center justify-center h-full pt-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-medium">æ­£åœ¨æƒæå‘¨åœåº—å®¶...</p>
            <p class="text-gray-400 text-xs mt-2">ç¯„åœï¼š<span id="loading-range-text"></span> å…¬å°º</p>
        </div>

        <!-- Results -->
        <div id="results-list" class="hidden pb-24 space-y-3"></div>

        <!-- Add Button for Pocket Mode -->
        <div id="pocket-add-btn" class="hidden fixed bottom-24 right-6 z-20">
            <button onclick="addToPocket()" class="bg-yellow-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-yellow-600 transition">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </main>

    <!-- FAB (Dice) -->
    <div id="fab-container" class="hidden absolute bottom-6 right-6 z-20">
        <button onclick="openWheel()" class="bg-gray-800 text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-gray-700 transition transform hover:rotate-12 active:scale-90 ring-4 ring-white">
            <i class="fa-solid fa-dice"></i>
        </button>
    </div>

    <!-- Wheel Modal -->
    <div id="wheel-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="relative w-80 h-80 mb-8">
            <div class="arrow-down"></div>
            <canvas id="wheel-canvas" width="320" height="320" class="w-full h-full drop-shadow-2xl"></canvas>
            <!-- Center dot -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-md z-10 flex items-center justify-center border-2 border-gray-200">
                <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
            </div>
        </div>
        <div id="wheel-msg" class="text-white text-xl font-bold animate-pulse">é»æ“Šè½‰ç›¤é–‹å§‹ï¼</div>
        <button onclick="closeWheel()" class="mt-8 text-gray-400 text-sm hover:text-white underline">å–æ¶ˆ</button>
    </div>

    <!-- Result Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="text-center relative">
                <button onclick="closeModal()" class="absolute -top-2 -right-2 text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-check text-2xl text-green-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-400 mb-1">å‘½é‹çš„é¸æ“‡ï¼</h3>
                <h2 id="modal-shop-name" class="text-2xl font-black text-gray-800 mb-2 leading-tight">åº—å®¶åç¨±</h2>
                <p id="modal-shop-type" class="text-sm text-gray-500 mb-4 bg-gray-100 inline-block px-3 py-1 rounded-full">é¡å‹</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveToHistoryAndClose()" class="col-span-2 py-2 bg-yellow-100 text-yellow-700 rounded-xl font-bold hover:bg-yellow-200 transition border border-yellow-200">
                        <i class="fa-solid fa-bookmark mr-1"></i> ç´€éŒ„ï¼šæˆ‘åƒé€™å®¶
                    </button>
                    <button onclick="shareShop()" class="py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">
                        <i class="fa-brands fa-line text-green-600"></i> åˆ†äº«
                    </button>
                    <button onclick="openGoogleMapsFromModal()" class="py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <i class="fa-solid fa-diamond-turn-right mr-2"></i> å»å°èˆª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-white z-[70] hidden flex flex-col transition-transform duration-300 translate-y-full">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-book-open text-orange-500 mr-2"></i>åƒè²¨ç´€éŒ„</h2>
            <button onclick="closeHistory()" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="history-list"></div>
        <div class="p-4 border-t border-gray-200 bg-white text-center">
            <button onclick="clearHistory()" class="text-red-500 text-sm font-medium">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-100 text-red-700 px-4 py-2 rounded-lg shadow-md text-sm whitespace-nowrap z-[80]">
        <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-text">ç™¼ç”ŸéŒ¯èª¤</span>
    </div>

    <script>
        // --- State Variables ---
        let currentUserLocation = null;
        let shopsData = []; // The current list being displayed (Map or Pocket)
        let currentMode = 'all'; 
        let currentCustomKeyword = '';
        let selectedShop = null;
        let currentRadius = 500;
        let historyData = JSON.parse(localStorage.getItem('foodHistory')) || [];
        let pocketList = JSON.parse(localStorage.getItem('myPocketList')) || [];

        // Wheel variables
        let wheelCanvas = document.getElementById('wheel-canvas');
        let wheelCtx = wheelCanvas.getContext('2d');
        let isSpinning = false;
        let currentRotation = 0;

        // --- DOM Elements ---
        const statusBadge = document.getElementById('status-badge');
        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultsList = document.getElementById('results-list');
        const fabContainer = document.getElementById('fab-container');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const historyModal = document.getElementById('history-modal');
        const rangeInput = document.getElementById('distance-range');
        const rangeValue = document.getElementById('range-value');
        const keywordBadge = document.getElementById('keyword-badge');
        const currentKeywordText = document.getElementById('current-keyword-text');
        const rangeContainer = document.getElementById('range-container');
        const pocketAddBtn = document.getElementById('pocket-add-btn');

        // --- Init ---
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });

        // --- Event Listeners ---
        rangeInput.addEventListener('input', (e) => {
            currentRadius = e.target.value;
            const text = currentRadius >= 1000 ? (currentRadius/1000) + " å…¬é‡Œ" : currentRadius + " å…¬å°º";
            rangeValue.innerText = text;
            document.getElementById('start-range-text').innerText = currentRadius;
        });

        rangeInput.addEventListener('change', () => {
            if (currentUserLocation && currentMode !== 'pocket') {
                fetchShops(currentUserLocation.lat, currentUserLocation.lng);
            }
        });

        // Wheel Click to Spin
        wheelCanvas.addEventListener('click', () => {
            if (!isSpinning) spinWheel();
        });

        // --- Configuration ---
        const modes = {
            'all': {
                color: 'bg-orange-500',
                generateQL: (lat, lng, r) => `
                    node(around:${r},${lat},${lng})["amenity"~"restaurant|fast_food|food_court|cafe"];
                    way(around:${r},${lat},${lng})["amenity"~"restaurant|fast_food|food_court|cafe"];
                `
            },
            'date': {
                color: 'bg-pink-500',
                generateQL: (lat, lng, r) => `
                    node(around:${r},${lat},${lng})["amenity"~"cafe|ice_cream"];
                    way(around:${r},${lat},${lng})["amenity"~"cafe|ice_cream"];
                `
            },
            'custom': {
                color: 'bg-blue-500',
                generateQL: (lat, lng, r, kw) => `
                    (
                      node(around:${r},${lat},${lng})["name"~"${kw}", i];
                      node(around:${r},${lat},${lng})["cuisine"~"${kw}", i];
                      way(around:${r},${lat},${lng})["name"~"${kw}", i];
                      way(around:${r},${lat},${lng})["cuisine"~"${kw}", i];
                    );
                `
            },
            'pocket': {
                color: 'bg-yellow-500'
            }
        };

        // --- Mode Switching ---

        function setMode(mode) {
            currentMode = mode;
            keywordBadge.classList.add('hidden');
            
            // Reset Button Styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.className = "filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition border border-gray-200";
            });

            // Highlight Active Button
            if (mode !== 'custom') { // Custom handles its own highlighting
                const activeBtn = document.getElementById(`btn-${mode}`);
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200', 'border-gray-200');
                activeBtn.classList.add(modes[mode].color, 'text-white', 'shadow-md', 'border-transparent');
            }

            // Logic Switch
            if (mode === 'pocket') {
                // Pocket Mode Logic
                rangeContainer.classList.add('opacity-50', 'pointer-events-none'); // Disable range slider
                renderPocketList();
            } else {
                // Map Mode Logic
                rangeContainer.classList.remove('opacity-50', 'pointer-events-none');
                pocketAddBtn.classList.add('hidden');
                currentCustomKeyword = ''; 
                
                if (currentUserLocation) {
                    fetchShops(currentUserLocation.lat, currentUserLocation.lng);
                } else if (mode !== 'all') {
                    // Trigger location if user clicks a mode before searching
                    getLocation();
                }
            }
        }

        async function askCustomSearch() {
            const { value: keyword } = await Swal.fire({
                title: 'æƒ³åƒä»€éº¼ï¼Ÿ',
                input: 'text',
                inputLabel: 'è¼¸å…¥é—œéµå­— (ä¾‹å¦‚ï¼šç«é‹ã€å£½å¸)',
                inputPlaceholder: 'è¼¸å…¥é—œéµå­—...',
                showCancelButton: true,
                confirmButtonColor: '#3B82F6',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonText: 'æœå°‹'
            });

            if (keyword) {
                currentCustomKeyword = keyword;
                currentMode = 'custom';
                
                // UI Reset
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.className = "filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition border border-gray-200";
                });
                const btnCustom = document.getElementById('btn-custom');
                btnCustom.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200', 'border-gray-200');
                btnCustom.classList.add('bg-blue-500', 'text-white', 'shadow-md', 'border-transparent');
                
                keywordBadge.classList.remove('hidden');
                currentKeywordText.innerText = keyword;

                if (!currentUserLocation) {
                    getLocation(); 
                } else {
                    fetchShops(currentUserLocation.lat, currentUserLocation.lng);
                }
            }
        }

        // --- Pocket List Logic ---

        function renderPocketList() {
            startScreen.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            resultsList.classList.remove('hidden');
            fabContainer.classList.remove('hidden');
            pocketAddBtn.classList.remove('hidden');

            shopsData = [...pocketList]; // Use pocket list as current data source

            if (shopsData.length === 0) {
                resultsList.innerHTML = `
                    <div class="text-center mt-10 text-gray-400 px-6">
                        <i class="fa-solid fa-star text-4xl mb-3 text-yellow-300"></i>
                        <h3 class="text-lg font-bold text-gray-600">å£è¢‹ç©ºç©ºçš„</h3>
                        <p class="text-sm mt-2">å¿«é»æ“Šå³ä¸‹è§’çš„ ï¼‹ æ–°å¢ä½ çš„æ„›åº—å§ï¼</p>
                    </div>
                `;
                return;
            }

            renderShopsUI(true); // true = isPocketMode
        }

        async function addToPocket() {
            const { value: formValues } = await Swal.fire({
                title: 'æ–°å¢å£è¢‹åå–®',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="åº—å (ä¾‹å¦‚: é˜¿å©†ä¹¾éºµ)">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="é¡å‹ (ä¾‹å¦‚: éºµåº—)">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'æ–°å¢',
                confirmButtonColor: '#EAB308',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            });

            if (formValues && formValues[0]) {
                const newItem = {
                    id: 'pocket_' + Date.now(),
                    name: formValues[0],
                    type: formValues[1] || 'ç¾é£Ÿ',
                    lat: null, // Pocket items might not have coords for now
                    lon: null,
                    distance: 'è‡ªè¨‚',
                    tags: {}
                };
                pocketList.unshift(newItem);
                localStorage.setItem('myPocketList', JSON.stringify(pocketList));
                renderPocketList(); // Refresh
                
                Swal.fire({
                    icon: 'success',
                    title: 'å·²åŠ å…¥ï¼',
                    timer: 1000,
                    showConfirmButton: false
                });
            }
        }

        function removeFromPocket(id, event) {
            event.stopPropagation(); // Prevent card click
            Swal.fire({
                title: 'ç§»é™¤é€™å®¶åº—ï¼Ÿ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                confirmButtonText: 'åˆªé™¤',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    pocketList = pocketList.filter(item => item.id !== id);
                    localStorage.setItem('myPocketList', JSON.stringify(pocketList));
                    renderPocketList();
                }
            });
        }

        // --- Location & Map Fetching ---

        function getLocation() {
            if (!navigator.geolocation) {
                showError("ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½");
                return;
            }
            statusBadge.classList.remove('hidden');
            statusBadge.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> å®šä½ä¸­...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusBadge.innerHTML = '<i class="fa-solid fa-location-arrow text-green-600 mr-1"></i> å®šä½æˆåŠŸ';
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                    fetchShops(currentUserLocation.lat, currentUserLocation.lng);
                },
                (error) => {
                    let msg = "ç„¡æ³•ç²å–ä½ç½®";
                    if (error.code === 1) msg = "è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™";
                    showError(msg);
                    statusBadge.innerHTML = 'å®šä½å¤±æ•—';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function fetchShops(lat, lng) {
            startScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            document.getElementById('loading-range-text').innerText = currentRadius;
            resultsList.classList.add('hidden');
            fabContainer.classList.add('hidden');

            try {
                let qlSnippet = '';
                if (currentMode === 'custom') {
                    qlSnippet = modes['custom'].generateQL(lat, lng, currentRadius, currentCustomKeyword);
                } else {
                    qlSnippet = modes[currentMode].generateQL(lat, lng, currentRadius);
                }

                const finalQuery = `
                    [out:json][timeout:25];
                    (
                      ${qlSnippet}
                    );
                    out center;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: finalQuery
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                processResults(data.elements);

            } catch (err) {
                console.error("Fetch Error:", err);
                showError("æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                loadingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        }

        function processResults(elements) {
            const uniqueIds = new Set();
            
            shopsData = elements.filter(el => {
                if (!el.tags || !el.tags.name) return false;
                if (uniqueIds.has(el.tags.name)) return false; 
                uniqueIds.add(el.tags.name);
                return true;
            }).map(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                const dist = getDistanceFromLatLonInKm(currentUserLocation.lat, currentUserLocation.lng, lat, lon);
                return {
                    id: el.id,
                    name: el.tags.name,
                    type: el.tags.cuisine || el.tags.shop || el.tags.amenity || 'åº—å®¶',
                    lat: lat,
                    lon: lon,
                    distance: dist.toFixed(2),
                    distanceM: Math.round(dist * 1000),
                    tags: el.tags
                };
            }).sort((a, b) => a.distance - b.distance);

            renderShopsUI(false);
        }

        // --- Rendering List ---

        function renderShopsUI(isPocketMode) {
            loadingScreen.classList.add('hidden');
            resultsList.classList.remove('hidden');
            resultsList.innerHTML = '';

            // Empty State
            if (shopsData.length === 0) {
                 let fallbackKeyword = currentCustomKeyword || (currentMode === 'date' ? 'æ°£æ°›å¥½çš„é¤å»³' : 'ç¾é£Ÿ');
                resultsList.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center mt-10 px-6">
                        <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-map-location-dot text-3xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">é€™è£¡çš„è³‡æ–™æœ‰é»å°‘...</h3>
                        <button onclick="openGoogleSearchFallback('${fallbackKeyword}')" class="w-full bg-blue-600 text-white py-4 rounded-xl shadow-lg flex items-center justify-center transform transition active:scale-95">
                            <i class="fa-brands fa-google mr-2"></i> å» Google Maps æœå°‹
                        </button>
                    </div>
                `;
                return;
            }

            fabContainer.classList.remove('hidden');
            
            const infoDiv = document.createElement('div');
            infoDiv.className = "px-4 py-2 text-xs text-gray-500 flex justify-between items-center";
            infoDiv.innerHTML = `<span>æ‰¾åˆ° ${shopsData.length} é–“åº—å®¶</span>`;
            resultsList.appendChild(infoDiv);

            shopsData.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm mx-4 flex justify-between items-center card-anim cursor-pointer border-l-4 border-transparent hover:border-orange-400 mb-3 relative group';
                
                let iconClass = 'fa-utensils';
                let iconColor = 'text-orange-400';
                
                // Icon Logic
                if(isPocketMode) {
                     iconClass = 'fa-star'; 
                     iconColor = 'text-yellow-400';
                } else {
                    const t = JSON.stringify(shop.tags).toLowerCase();
                    if (t.includes('cafe') || t.includes('coffee')) { iconClass = 'fa-mug-hot'; iconColor = 'text-pink-400'; }
                    else if (t.includes('burger') || t.includes('fast_food')) { iconClass = 'fa-burger'; iconColor = 'text-yellow-500'; }
                    else if (t.includes('japanese') || t.includes('sushi')) { iconClass = 'fa-fish'; iconColor = 'text-red-400'; }
                    else if (t.includes('noodle') || t.includes('ramen')) { iconClass = 'fa-bowl-food'; iconColor = 'text-yellow-600'; }
                    else if (t.includes('bar')) { iconClass = 'fa-martini-glass'; iconColor = 'text-purple-500'; }
                }

                let distanceText = shop.distance === 'è‡ªè¨‚' ? 'è‡ªè¨‚åå–®' : 
                                   (shop.distanceM < 1000 ? shop.distanceM + ' m' : shop.distance + ' km');

                let deleteBtn = '';
                if(isPocketMode) {
                    deleteBtn = `<button onclick="removeFromPocket('${shop.id}', event)" class="ml-2 w-8 h-8 rounded-full text-gray-300 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition"><i class="fa-solid fa-trash"></i></button>`;
                }

                card.innerHTML = `
                    <div class="flex items-center overflow-hidden flex-1">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 mr-3">
                            <i class="fa-solid ${iconClass} ${iconColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-gray-800 truncate text-base">${shop.name}</h3>
                            <p class="text-xs text-gray-500 truncate">
                                <i class="fa-solid fa-location-dot text-gray-300"></i> ${distanceText} 
                                <span class="mx-1">â€¢</span> ${translateType(shop.type)}
                            </p>
                        </div>
                    </div>
                    ${deleteBtn}
                    <div class="flex-shrink-0 ml-2 ${isPocketMode ? 'hidden' : ''}">
                         <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                    </div>
                `;
                card.onclick = () => {
                    selectedShop = shop;
                    updateModalUI();
                    openModal();
                };
                resultsList.appendChild(card);
            });
            
            const spacer = document.createElement('div');
            spacer.className = 'h-24'; // Extra space for FAB and Pocket Add Btn
            resultsList.appendChild(spacer);
        }

        // --- Wheel of Fortune Logic ---

        function openWheel() {
            if (shopsData.length === 0) return;
            document.getElementById('wheel-modal').classList.remove('hidden');
            document.getElementById('wheel-msg').innerText = "é»æ“Šè½‰ç›¤é–‹å§‹ï¼";
            isSpinning = false;
            drawWheel();
        }

        function closeWheel() {
            document.getElementById('wheel-modal').classList.add('hidden');
        }

        function drawWheel() {
            // Draw logic
            const count = shopsData.length;
            const arc = (2 * Math.PI) / count;
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43', '#54A0FF', '#5F27CD', '#FD79A8'];
            
            wheelCtx.clearRect(0, 0, 320, 320);
            wheelCtx.save();
            wheelCtx.translate(160, 160);
            // Rotate based on current rotation state so it looks like it's stopped/spinning
            wheelCtx.rotate(currentRotation);

            for (let i = 0; i < count; i++) {
                const angle = i * arc;
                wheelCtx.beginPath();
                wheelCtx.fillStyle = colors[i % colors.length];
                wheelCtx.moveTo(0, 0);
                wheelCtx.arc(0, 0, 150, angle, angle + arc);
                wheelCtx.lineTo(0, 0);
                wheelCtx.fill();
                
                // Text
                wheelCtx.save();
                wheelCtx.translate(Math.cos(angle + arc / 2) * 100, Math.sin(angle + arc / 2) * 100);
                wheelCtx.rotate(angle + arc / 2 + Math.PI / 2);
                wheelCtx.fillStyle = '#fff';
                wheelCtx.font = 'bold 12px Arial';
                let text = shopsData[i].name;
                if(text.length > 6) text = text.substring(0,5) + '..';
                wheelCtx.fillText(text, -wheelCtx.measureText(text).width / 2, 0);
                wheelCtx.restore();
            }
            
            // Outer Ring
            wheelCtx.beginPath();
            wheelCtx.arc(0, 0, 150, 0, 2 * Math.PI);
            wheelCtx.lineWidth = 5;
            wheelCtx.strokeStyle = '#fff';
            wheelCtx.stroke();
            
            wheelCtx.restore();
        }

        function spinWheel() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('wheel-msg').innerText = "å‘½é‹è½‰å‹•ä¸­...";

            // Determine winner randomly
            const winnerIndex = Math.floor(Math.random() * shopsData.length);
            const arc = (2 * Math.PI) / shopsData.length;
            
            // Calculate stopping angle
            // The pointer is at 270 degrees (Top center is 3/2 PI or -PI/2)
            // But our arrow is physically at top.
            // We need the wheel to rotate such that the winner segment is at the top (-90deg / 270deg)
            // Target rotation = (360 * rounds) - (winnerIndex * arc) - (random offset inside segment)
            
            const spins = 5 + Math.random() * 5; // 5 to 10 full spins
            const spinAngle = spins * 2 * Math.PI;
            
            // Center of segment
            const segmentCenter = (winnerIndex * arc) + (arc / 2);
            
            // To align segment center with top arrow (-PI/2), we subtract the segment position
            // But since canvas rotates clockwise, we subtract.
            // Add -PI/2 to align 0 rad (3 o'clock) to top (12 o'clock)
            const targetRotation = spinAngle - segmentCenter - (Math.PI/2); 

            let start = null;
            const duration = 4000; // ms

            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const percent = Math.min(progress / duration, 1);
                
                // Ease out cubic
                const ease = 1 - Math.pow(1 - percent, 3);
                
                currentRotation = targetRotation * ease;
                drawWheel();

                if (progress < duration) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    setTimeout(() => {
                        selectedShop = shopsData[winnerIndex];
                        closeWheel();
                        updateModalUI();
                        openModal();
                    }, 500);
                }
            }
            requestAnimationFrame(animate);
        }

        // --- Common Logic ---

        function updateModalUI() {
            document.getElementById('modal-shop-name').innerText = selectedShop.name;
            document.getElementById('modal-shop-type').innerText = translateType(selectedShop.type);
        }

        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveToHistoryAndClose() {
            if (!selectedShop) return;
            const record = {
                name: selectedShop.name,
                date: new Date().toLocaleDateString('zh-TW'),
                timestamp: Date.now(),
                type: translateType(selectedShop.type)
            };
            historyData.unshift(record);
            localStorage.setItem('foodHistory', JSON.stringify(historyData));

            Swal.fire({
                icon: 'success',
                title: 'ç´€éŒ„æˆåŠŸï¼',
                text: `å·²ç´€éŒ„ä»Šå¤©åƒã€Œ${selectedShop.name}ã€`,
                timer: 1500,
                showConfirmButton: false,
                confirmButtonColor: '#F97316'
            });
            closeModal();
        }

        function shareShop() {
            if (!selectedShop) return;
            const text = `ä»Šå¤©åƒé€™å€‹å§ï¼\nğŸ“ ${selectedShop.name}\nğŸ”— Google Maps: https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(selectedShop.name)}`;
            
            if (navigator.share) {
                navigator.share({ title: 'ä»Šå¤©åƒä»€éº¼ï¼Ÿ', text: text }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    Swal.fire({ icon: 'success', title: 'å·²è¤‡è£½ï¼', text: 'å¯ä»¥å» LINE è²¼çµ¦æ£ æ£ å›‰', timer: 1500, showConfirmButton: false });
                });
            }
        }

        // --- History Logic ---
        function openHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (historyData.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fa-solid fa-cookie-bite text-4xl mb-2"></i><p>é‚„æ²’æœ‰ç´€éŒ„å–”</p></div>`;
            } else {
                historyData.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center border-b border-gray-100 py-3";
                    el.innerHTML = `
                        <div>
                            <div class="text-xs text-gray-400 mb-1">${item.date}</div>
                            <div class="font-bold text-gray-800">${item.name}</div>
                        </div>
                        <button onclick="deleteHistoryItem(${index})" class="text-gray-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                    `;
                    list.appendChild(el);
                });
            }
            historyModal.classList.remove('hidden', 'translate-y-full');
            historyModal.classList.add('translate-y-0');
        }
        function closeHistory() { historyModal.classList.add('translate-y-full'); setTimeout(() => { historyModal.classList.add('hidden'); }, 300); }
        function deleteHistoryItem(index) { historyData.splice(index, 1); localStorage.setItem('foodHistory', JSON.stringify(historyData)); openHistory(); }
        function clearHistory() { if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) { historyData = []; localStorage.setItem('foodHistory', JSON.stringify(historyData)); openHistory(); } }

        // --- Navigation ---
        function openGoogleMapsFromModal() {
            if(selectedShop) {
                const query = encodeURIComponent(selectedShop.name);
                let url;
                if(selectedShop.lat) {
                    url = `https://www.google.com/maps/search/?api=1&query=${query}&query_place_id=${selectedShop.lat},${selectedShop.lon}`;
                } else {
                    // Pocket list item might not have coords
                    url = `https://www.google.com/maps/search/?api=1&query=${query}`;
                }
                window.open(url, '_blank');
            }
        }

        function openGoogleSearchFallback(keyword) {
            if(!keyword) keyword = currentCustomKeyword || 'ç¾é£Ÿ';
             const url = `https://www.google.com/maps/search/${keyword}/@${currentUserLocation.lat},${currentUserLocation.lng},15z/data=!3m1!4b1`;
            window.open(url, '_blank');
        }

        // --- Helpers ---
        function translateType(type) {
            const dict = {
                'restaurant': 'é¤å»³', 'fast_food': 'é€Ÿé£Ÿ', 'cafe': 'å’–å•¡å»³', 'ice_cream': 'å†°æ·‡æ·‹',
                'noodle': 'éºµåº—', 'japanese': 'æ—¥å¼æ–™ç†', 'burger': 'æ¼¢å ¡', 'pizza': 'æŠ«è–©', 'bar': 'é…’å§'
            };
            return dict[type] || 'é¤å»³';
        }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }
        function showError(text) {
            const errDiv = document.getElementById('error-msg');
            document.getElementById('error-text').innerText = text;
            errDiv.classList.remove('hidden');
            setTimeout(() => { errDiv.classList.add('hidden'); }, 3000);
        }
    </script>
</body>
</html>

