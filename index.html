<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 隨身試衣間</title>
    
    <!-- 引入 Tailwind CSS 快速樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Fabric.js 用於圖片操作 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- 引入圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { touch-action: manipulation; background-color: #f3f4f6; }
        .canvas-container { margin: 0 auto; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab-inactive { color: #6b7280; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="flex flex-col h-screen max-w-md mx-auto bg-white shadow-xl overflow-hidden">
    
    <!-- 頂部導航 -->
    <header class="bg-white p-4 text-center border-b z-10">
        <h1 class="text-xl font-bold text-gray-800">隨身試衣間 Web</h1>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-1 overflow-y-auto p-4 relative">
        
        <!-- 1. 設定頁面 (如果沒有基礎身體) -->
        <div v-if="currentTab === 'profile'" class="space-y-6 text-center">
            <h2 class="text-lg font-semibold">設定您的基礎模型</h2>
            
            <div class="relative w-full h-80 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
                <img v-if="bodyImageSrc" :src="bodyImageSrc" class="w-full h-full object-contain">
                <div v-else class="text-gray-400">
                    <i class="fas fa-user text-6xl mb-2"></i>
                    <p>請上傳全身照</p>
                </div>
                
                <!-- 隱藏的檔案輸入 -->
                <input type="file" ref="bodyInput" @change="handleBodyUpload" accept="image/*" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
            </div>

            <p class="text-sm text-gray-500">提示：請穿著合身衣物，正面站立。<br>設定後可隨時更換。</p>
            
            <button @click="saveProfile" :disabled="!bodyImageSrc" 
                class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold disabled:bg-gray-300">
                保存設定
            </button>
        </div>

        <!-- 2. 試衣頁面 -->
        <div v-show="currentTab === 'tryon'" class="flex flex-col h-full">
            <div v-if="!bodyImageSrc" class="text-center mt-10">
                <p class="text-red-500 mb-4">尚未設定人物模型</p>
                <button @click="currentTab = 'profile'" class="text-blue-600 underline">前往設定</button>
            </div>

            <div v-else class="flex flex-col h-full">
                <!-- 畫布區域 -->
                <div class="relative flex-1 bg-gray-200 rounded-lg flex justify-center items-center overflow-hidden mb-4 border border-gray-300">
                    <canvas id="c"></canvas>
                    
                    <!-- 提示層 -->
                    <div v-if="!hasCloth" class="absolute pointer-events-none text-gray-400 text-sm bg-white/80 px-2 py-1 rounded">
                        上傳衣服後，可用手指縮放、旋轉
                    </div>
                </div>

                <!-- 控制按鈕 -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <!-- 上傳衣服 -->
                    <label class="flex flex-col items-center justify-center p-3 bg-blue-50 text-blue-600 rounded-lg cursor-pointer active:bg-blue-100">
                        <i class="fas fa-tshirt text-xl mb-1"></i>
                        <span class="text-xs font-bold">加衣服</span>
                        <input type="file" @change="handleAddCloth" accept="image/*" class="hidden">
                    </label>

                    <!-- 清除衣服 -->
                    <button @click="clearClothes" class="flex flex-col items-center justify-center p-3 bg-red-50 text-red-600 rounded-lg active:bg-red-100">
                        <i class="fas fa-trash text-xl mb-1"></i>
                        <span class="text-xs font-bold">清除衣物</span>
                    </button>

                    <!-- 保存結果 -->
                    <button @click="saveResult" class="flex flex-col items-center justify-center p-3 bg-green-50 text-green-600 rounded-lg active:bg-green-100">
                        <i class="fas fa-camera text-xl mb-1"></i>
                        <span class="text-xs font-bold">保存搭配</span>
                    </button>
                </div>
                
                <!-- 圖層控制 (簡單版) -->
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded text-xs text-gray-500">
                    <span>選中衣物操作：</span>
                    <div>
                        <button @click="moveLayer('up')" class="px-2 py-1 bg-white border rounded mr-1">上移</button>
                        <button @click="moveLayer('down')" class="px-2 py-1 bg-white border rounded">下移</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 歷史紀錄頁面 -->
        <div v-if="currentTab === 'history'" class="space-y-4">
            <div v-if="history.length === 0" class="text-center text-gray-400 mt-10">
                <i class="fas fa-history text-4xl mb-2"></i>
                <p>尚無試穿紀錄</p>
            </div>
            
            <div v-for="(item, index) in history" :key="index" class="bg-white border rounded-lg overflow-hidden shadow-sm relative">
                <img :src="item.image" class="w-full h-64 object-cover object-top">
                <div class="p-3 flex justify-between items-center">
                    <span class="text-sm text-gray-500">{{ item.date }}</span>
                    <button @click="deleteHistory(index)" class="text-red-500 text-sm">刪除</button>
                </div>
            </div>
        </div>

    </main>

    <!-- 底部 Tab Bar -->
    <nav class="bg-white border-t flex justify-around py-3 pb-safe">
        <button @click="currentTab = 'tryon'" :class="currentTab === 'tryon' ? 'tab-active' : 'tab-inactive'" class="flex flex-col items-center w-1/3">
            <i class="fas fa-magic text-xl mb-1"></i>
            <span class="text-xs">試衣</span>
        </button>
        <button @click="currentTab = 'history'" :class="currentTab === 'history' ? 'tab-active' : 'tab-inactive'" class="flex flex-col items-center w-1/3">
            <i class="fas fa-clock text-xl mb-1"></i>
            <span class="text-xs">紀錄</span>
        </button>
        <button @click="currentTab = 'profile'" :class="currentTab === 'profile' ? 'tab-active' : 'tab-inactive'" class="flex flex-col items-center w-1/3">
            <i class="fas fa-user-circle text-xl mb-1"></i>
            <span class="text-xs">設定</span>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            const currentTab = ref('profile'); // 預設頁面
            const bodyImageSrc = ref(null);
            const history = ref([]);
            const canvas = ref(null);
            const hasCloth = ref(false);

            // 初始化
            onMounted(() => {
                // 讀取 LocalStorage
                const savedBody = localStorage.getItem('vton_body_image');
                if (savedBody) {
                    bodyImageSrc.value = savedBody;
                    currentTab.value = 'tryon'; // 有設定就直接去試衣
                }
                
                const savedHistory = localStorage.getItem('vton_history');
                if (savedHistory) {
                    history.value = JSON.parse(savedHistory);
                }

                initCanvas();
            });

            // 監聽 Tab 切換，如果是試衣頁面，重新調整 Canvas
            watch(currentTab, (newTab) => {
                if (newTab === 'tryon') {
                    nextTick(() => {
                        initCanvas();
                        if (bodyImageSrc.value) {
                            setCanvasBackground(bodyImageSrc.value);
                        }
                    });
                }
            });

            // 初始化 Fabric Canvas
            const initCanvas = () => {
                const canvasEl = document.getElementById('c');
                if (!canvasEl) return;
                
                // 避免重複初始化
                if (canvas.value) {
                    canvas.value.clear();
                    // 重新設置背景
                    if (bodyImageSrc.value) setCanvasBackground(bodyImageSrc.value);
                    return;
                }

                // 計算父容器寬度
                const parentWidth = canvasEl.parentElement.offsetWidth;
                const height = window.innerHeight * 0.55; // 佔據螢幕高度的 55%

                canvas.value = new fabric.Canvas('c', {
                    width: parentWidth,
                    height: height,
                    preserveObjectStacking: true // 保持選中物體層級
                });
            };

            // 設定人物背景
            const setCanvasBackground = (imgSrc) => {
                if (!canvas.value) return;
                
                fabric.Image.fromURL(imgSrc, (img) => {
                    // 調整背景圖以適應 Canvas (contain 模式)
                    const canvasAspect = canvas.value.width / canvas.value.height;
                    const imgAspect = img.width / img.height;
                    
                    let scaleFactor;
                    if (imgAspect > canvasAspect) {
                        scaleFactor = canvas.value.width / img.width;
                    } else {
                        scaleFactor = canvas.value.height / img.height;
                    }

                    img.set({
                        originX: 'center',
                        originY: 'center',
                        scaleX: scaleFactor,
                        scaleY: scaleFactor
                    });

                    canvas.value.setBackgroundImage(img, canvas.value.renderAll.bind(canvas.value), {
                        top: canvas.value.height / 2,
                        left: canvas.value.width / 2
                    });
                }, { crossOrigin: 'anonymous' });
            };

            // 上傳/更換身體圖片
            const handleBodyUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    // 壓縮圖片以避免 LocalStorage 爆掉
                    compressImage(event.target.result, 800, (compressedSrc) => {
                        bodyImageSrc.value = compressedSrc;
                    });
                };
                reader.readAsDataURL(file);
            };

            // 保存個人設定
            const saveProfile = () => {
                if (bodyImageSrc.value) {
                    try {
                        localStorage.setItem('vton_body_image', bodyImageSrc.value);
                        alert('設定已保存！以後不需要重新上傳。');
                        currentTab.value = 'tryon';
                    } catch (e) {
                        alert('圖片過大，儲存失敗。請嘗試使用較小的圖片。');
                    }
                }
            };

            // 添加衣服
            const handleAddCloth = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    fabric.Image.fromURL(event.target.result, (img) => {
                        // 預設縮放衣服大小
                        img.scaleToWidth(canvas.value.width * 0.5);
                        
                        img.set({
                            left: canvas.value.width / 2,
                            top: canvas.value.height / 2,
                            originX: 'center',
                            originY: 'center',
                            cornerColor: 'blue',
                            cornerStyle: 'circle',
                            borderColor: 'blue',
                            transparentCorners: false
                        });

                        canvas.value.add(img);
                        canvas.value.setActiveObject(img);
                        hasCloth.value = true;
                    });
                };
                reader.readAsDataURL(file);
            };

            // 清除所有衣服
            const clearClothes = () => {
                if (!canvas.value) return;
                canvas.value.getObjects().forEach((obj) => {
                    canvas.value.remove(obj);
                });
                hasCloth.value = false;
            };

            // 圖層移動
            const moveLayer = (direction) => {
                const activeObj = canvas.value.getActiveObject();
                if (!activeObj) return;
                
                if (direction === 'up') activeObj.bringForward();
                else activeObj.sendBackwards();
                
                canvas.value.renderAll();
            };

            // 保存結果
            const saveResult = () => {
                if (!canvas.value) return;
                
                // 取消選中框以便截圖
                canvas.value.discardActiveObject();
                canvas.value.renderAll();

                const resultDataUrl = canvas.value.toDataURL({
                    format: 'png',
                    quality: 0.8
                });

                // 加入歷史紀錄
                const newRecord = {
                    image: resultDataUrl,
                    date: new Date().toLocaleString()
                };
                
                history.value.unshift(newRecord); // 加到最前面
                
                // 限制歷史紀錄數量 (避免 LocalStorage 爆掉)
                if (history.value.length > 10) {
                    history.value.pop();
                }

                try {
                    localStorage.setItem('vton_history', JSON.stringify(history.value));
                    
                    // 下載圖片到手機
                    const link = document.createElement('a');
                    link.download = `tryon-${Date.now()}.png`;
                    link.href = resultDataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert('搭配已保存到歷史紀錄與相簿！');
                } catch (e) {
                    alert('儲存空間不足，請刪除部分歷史紀錄。');
                }
            };

            // 刪除單筆紀錄
            const deleteHistory = (index) => {
                history.value.splice(index, 1);
                localStorage.setItem('vton_history', JSON.stringify(history.value));
            };

            // 圖片壓縮工具函數
            const compressImage = (src, maxWidth, callback) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    callback(canvas.toDataURL('image/jpeg', 0.7)); // 壓縮品質 0.7
                };
            };

            return {
                currentTab,
                bodyImageSrc,
                history,
                handleBodyUpload,
                saveProfile,
                handleAddCloth,
                clearClothes,
                saveResult,
                deleteHistory,
                hasCloth,
                moveLayer
            };
        }
    }).mount('#app');
</script>
</body>
</html>
